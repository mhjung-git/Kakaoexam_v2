SELECT 1+1;

CREATE TABLE `TMP_TBL` (
	`ID` INT(10) PRIMARY KEY,
	`ROOM` VARCHAR(10) NOT NULL
)ENGINE=InnoDB DEFAULT CHARSET=UTF8;

CREATE TABLE `TMP_TBL2` (
	`ID` VARCHAR(10) PRIMARY KEY,
	`ROOM` VARCHAR(10) NOT NULL
)ENGINE=InnoDB DEFAULT CHARSET=UTF8;

select ID, ROOM 
		from tmp_tbl2; 

select * 
		from tmp_tbl;
select NVL(ID, ''), NVL(ROOM, '') 
		from tmp_tbl2; 

INSERT INTO TMP_TBL VALUES(1, 'room1');
INSERT INTO TMP_TBL VALUES(2, 'room2');
INSERT INTO TMP_TBL VALUES(3, 'room3');

INSERT INTO TMP_TBL2 VALUES('1', 'room1');
INSERT INTO TMP_TBL2 VALUES('2', 'room2');
INSERT INTO TMP_TBL2 VALUES('3', 'room3');

COMMIT;





--Ω√¿€--

CREATE TABLE `TM_USER` (
	`ID` VARCHAR(10) PRIMARY KEY,
	`ROOM` VARCHAR(10) NOT NULL
)ENGINE=InnoDB DEFAULT CHARSET=UTF8;

SELECT * FROM TM_USER;

CREATE TABLE `TT_SPRINKLING` (
	SEQ INT AUTO_INCREMENT PRIMARY KEY,
	`TOKEN` VARCHAR(10) NOT NULL,
	`TOT_AMT` INT(10) NOT NULL,
	`DIVI_AMT`INT(10) NOT NULL,
	`STATUS_CD` VARCHAR(2) NOT NULL,
	`ACTION_ID` VARCHAR(10) NOT NULL,
	`INSERT_DT` VARCHAR(14)
)ENGINE=InnoDB DEFAULT CHARSET=UTF8;

ALTER TABLE TM_USER RENAME TT_SPRINKLING;

SELECT * FROM TT_SPRINKLING;

ALTER TABLE TT_SPRINKLING MODIFY COLUMN TOKEN VARCHAR(30);

COMMIT;

DESC tm_user;
SELECT * FROM tm_user;
SELECT * FROM tt_sprinkling;
DELETE FROM tt_sprinkling;
INSERT INTO tt_sprinkling(
				TOKEN, 
				TOT_AMT, 
				DIVI_AMT, 
				STATUS_CD, 
				ROOM_ID,
				ACTION_ID, 
				INSERT_DT
				)
	  VALUES
				('123',
					10000,
					5000,
					'11',
					(SELECT room FROM tm_user WHERE ID = '1'),
					'1',
					NOW()

				);
									--date_format(NOW(), '%Y%m%d%H%i%s')
ALTER TABLE TT_SPRINKLING MODIFY COLUMN INSERT_DT VARCHAR(14);
ALTER TABLE TT_SPRINKLING MODIFY COLUMN INSERT_DT TIMEstamp;
DELETE FROM tt_sprinkling;
SELECT NOW();
SELECT date_format(NOW(), '%Y%m%d%H%i%s') - INSERT_DT FROM tt_sprinkling;
SELECT * FROM TT_SPRINKLING;
20201123145727
SELECT * FROM tm_user;

INSERT INTO tm_user VALUES('1', 'room1');
INSERT INTO TMP_TBL2 VALUES('2', 'room2');
INSERT INTO TMP_TBL2 VALUES('3', 'room3');

COMMIT;

SELECT COUNT(*)
		FROM TM_USER
		WHERE ID = '1'
		AND ROOM = 'room1'; 
		
ALTER TABLE TT_SPRINKLING ADD COLUMN ROOM_ID VARCHAR(10) AFTER STATUS_CD;

SELECT * FROM tt_sprinkling;

COMMIT;

SELECT DATE_ADD(INSERT_DT, INTERVAL 10 MINUTE) FROM tt_sprinkling;
UPDATE tt_sprinkling SET 
--SELECT COUNT(*) AS CNT
SELECT *
FROM tt_sprinkling
WHERE TOKEN = 'TEST'
AND RECIEVE_ID  = 'MHJ'
AND INSERT_DT <= DATE_ADD(INSERT_DT, INTERVAL 10 MINUTE);

SELECT * FROM tt_sprinkling
WHERE seq = (select max(seq) FROM tt_sprinkling WHERE token='TEST');

UPDATE tt_sprinkling SET STATUS_CD='11', RECIEVE_ID='COMPLETE'
WHERE seq = (select max(seq) FROM tt_sprinkling WHERE token='TEST');

SELECT divi_amt 
FROM tt_sprinkling
WHERE seq = (select max(seq) FROM tt_sprinkling WHERE token='TEST' AND recieve_id IS NOT NULL);

SELECT COUNT(*) AS CNT
  FROM TT_SPRINKLING
 WHERE TOKEN = 'TEST'
 	AND STATUS_CD = '0'
 	AND NOW() BETWEEN INSERT_DT AND DATE_ADD(INSERT_DT, INTERVAL 10 MINUTE)
   AND RECIEVE_ID IS NULL
	AND ACTION_ID != #{recieve_id}
	

--		   AND INSERT_DT <= NOW()
--		   AND TIMESTAMPDIFF(minute, DATE_ADD(INSERT_DT, INTERVAL 20 MINUTE), NOW()) <= 10

SELECT * FROM tt_sprinkling
WHERE INSERT_DT <= DATE_ADD(INSERT_DT, INTERVAL 10 MINUTE)
AND TOKEN = 'TEST'
AND STATUS_CD = '0'
AND RECIEVE_ID IS NULL
AND ACTION_ID = '1'

SELECT * FROM tt_sprinkling
WHERE NOW() BETWEEN INSERT_DT AND DATE_ADD(INSERT_DT, INTERVAL 40 MINUTE)
AND TOKEN = 'TEST'
AND STATUS_CD = '0'
AND RECIEVE_ID IS NULL 
AND ACTION_ID = '1'



SELECT timediff(DATE_ADD('2020-11-23 14:36:52', INTERVAL 10 MINUTE), NOW()) FROM tt_sprinkling
WHERE seq = 13;
			2020-11-23 14:36:52
SELECT * FROM tt_sprinkling
DESC tt_sprinkling;

--WHERE DATE_ADD(INSERT_DT, INTERVAL 10 MINUTE) >= NOW();
SELECT * FROM tt_sprinkling
where TIMESTAMPDIFF(minute, DATE_ADD(INSERT_DT, INTERVAL 10 MINUTE), NOW()) <= 10



SELECT DIVI_AMT, RECIEVE_ID
FROM tt_sprinkling
WHERE TOKEN = '123'
AND INSERT_DT = '2020-11-23 19:34:43'
AND ACTION_ID = '1'
AND NOW() BETWEEN INSERT_DT AND DATE_ADD(INSERT_DT, INTERVAL 7 DAY)
AND STATUS_CD = '11'
ORDER BY INSERT_DT

SELECT INSERT_DT, TOT_AMT, SUM(DIVI_AMT) AS TOT_RECV_AMT
FROM tt_sprinkling
WHERE TOKEN = '123'
AND ACTION_ID = '1'
AND NOW() BETWEEN INSERT_DT AND DATE_ADD(INSERT_DT, INTERVAL 7 DAY)
AND STATUS_CD = '11'
GROUP BY INSERT_DT
ORDER BY INSERT_DT


UPDATE tt_sprinkling SET recieve_id ='ttttt'
WHERE seq = 16;

SELECT * FROM tt_sprinkling;

UPDATE tt_sprinkling SET insert_dt='2020-11-23 19:34:43' WHERE seq=17;
INSERT INTO tt_sprinkling(
				TOKEN, 
				TOT_AMT, 
				DIVI_AMT, 
				
				STATUS_CD, 
				ROOM_ID,
				ACTION_ID, 
				INSERT_DT
				)
	  VALUES
				('123',
					10000,
					2000,
					'11',
					(SELECT room FROM tm_user WHERE ID = '1'),
					'1',  
					NOW()

				);